/**
 *
 * jQuery plugin to impliment RSA public key encryption for
 * form submissions.
 *
 * Utilizes the pidCrypt libraries for client public key
 * encryption while the associated PHP class uses
 * OpenSSL to generate the necessary private/public key pairs used
 * by this plug-in
 *
 * Fork me @ https://www.github.com/jas-/jQuery.pidCrypt
 *
 * Author: Jason Gerfen <jason.gerfen@gmail.com>
 * License: GPL (see LICENSE)
 *
 */

(function(a){a.fn.pidCrypt=function(N){var w={storage:"localStorage",form:a(this).attr("id"),proxy:a(this).attr("action"),type:a(this).attr("method"),aes:"",cache:true,debug:false,data:{},callback:function(){}};var x={init:function(Q){var R=a.extend({},w,Q);if(n(R)){R.aes=g();F(R);i(R);a("#"+R.form).live("submit",function(S){S.preventDefault();(R.debug)?a("#"+R.form).append(B(R)):false;h(R)})}return true},sign:function(Q){var R=a.extend({},w,Q);if(n(R)){R.aes=g();F(R);i(R);a("#"+R.form).live("submit",function(S){S.preventDefault();R.data["do"]="sign";(R.debug)?a("#"+R.form).append(B(R)):false;h(R)})}return true},verify:function(Q){var R=a.extend({},w,Q);if(n(R)){R.aes=g();F(R);i(R);K(R);p(R,"signed");a("#"+R.form).live("submit",function(S){S.preventDefault();R.data["do"]="verify";(R.debug)?a("#"+R.form).append(B(R)):false;h(R)})}return true},encrypt_sign:function(Q){var R=a.extend({},w,Q);if(n(R)){R.aes=g();F(R);i(R);a("#"+R.form).live("submit",function(S){S.preventDefault();R.data["do"]="encrypt_sign";(R.debug)?a("#"+R.form).append(B(R)):false;h(R)})}return true},decrypt_verify:function(Q){var R=a.extend({},w,Q);if(n(R)){R.aes=g();F(R);i(R);K(R);p(R,"decrypt_verify");a("#"+R.form).live("submit",function(S){S.preventDefault();R.data["do"]="decrypt_verify";(R.debug)?a("#"+R.form).append(B(R)):false;h(R)})}return true},authenticate:function(Q){var R=a.extend({},w,Q);if(n(R)){R.aes=g();F(R);i(R);l(R);a("#"+R.form).live("submit",function(S){S.preventDefault();R.data["do"]="authenticate";R.data.c=q(R);(R.debug)?a("#"+R.form).append(B(R)):false;h(R)})}return true}};var h=function(R){var Q=c(R,P(R));Q=(A(R.data)>0)?a.extend({},Q,R.data):Q;(R.debug)?z(R,Q):false;a.ajax({data:Q,type:R.type,url:R.proxy,context:R.id,beforeSend:function(S){S.setRequestHeader("X-Alt-Referer","jQuery.pidCrypt")},success:function(S){(R.debug)?a("#"+R.form).append("<b>Server response:</b><br/>&nbsp;"+S):false;((R.callback)&&(a.isFunction(R.callback)))?R.callback.call(S):false},complete:function(S){(!R.cache)?C(R):""}});return false};var M=function(T,S,R){var Q=J(S);a.ajax({data:Q,type:"post",url:T.proxy,beforeSend:function(U){U.setRequestHeader("X-Alt-Referer","jQuery.pidCrypt")},success:function(U){e(T.storage,R,T.aes.encryptText(U,d(T.storage,"uuid"),{nBits:256,salt:d(T.storage,"iv")}))}});return false};var J=function(R){if(A(R)>0){var Q="";a.each(R,function(T,S){if(typeof S==="object"){J(S)}else{Q+=T+"="+S}})}else{return false}return Q};var c=function(R,S){var Q={};var T=I(L(R));s(R,T);if(A(S)>0){a.each(S,function(V,U){if(typeof U==="object"){Q[V]={};a.each(U,function(X,W){Q[V][X]=pidCrypt.RSA.prototype.encrypt(W)})}else{Q[V]=pidCrypt.RSA.prototype.encrypt(U)}})}else{Q=0}return Q};var g=function(){return new pidCrypt.AES.CBC()};var s=function(S,V){if(V.b64){var R=pidCryptUtil.decodeBase64(V.b64);var U=new pidCrypt();var T=pidCrypt.ASN1.decode(pidCryptUtil.toByteArray(R));var Q=T.toHexTree();pidCrypt.RSA.prototype.setPublicKeyFromASN(Q)}return U};var D=function(Q){var V="0123456789abcdef".split("");var T=[],S=Math.random,U;T[8]=T[13]=T[18]=T[23]="-";T[14]="4";for(var R=0;R<36;R++){if(!T[R]){U=0|S()*16;T[R]=V[(R==19)?(U&3)|8:U&15]}}return(Q!==null)?T.join("").replace(/-/g,"").split("",Q).join(""):T.join("")};var F=function(Q){(d(Q.storage,"uuid")&&(Q.cache))?d(Q.storage,"uuid"):e(Q.storage,"uuid",D(null));((d(Q.storage,"iv"))&&(Q.cache))?d(Q.storage,"iv"):e(Q.storage,"iv",D(16))};var i=function(Q){(d(Q.storage,"pub")&&(Q.cache))?d(Q.storage,"pub"):M(Q,{k:true},"pub")};var l=function(Q){(d(Q.storage,"certificate")&&(Q.cache))?d(Q.storage,"certificate"):M(Q,{c:true},"certificate")};var K=function(Q){(d(Q.storage,"signed")&&(Q.cache))?d(Q.storage,"signed"):M(Q,{e:true},"signed")};var L=function(Q){return Q.aes.decryptText(d(Q.storage,"pub"),d(Q.storage,"uuid"),{nBits:256,salt:d(Q.storage,"iv")})};var q=function(Q){return Q.aes.decryptText(d(Q.storage,"certificate"),d(Q.storage,"uuid"),{nBits:256,salt:d(Q.storage,"iv")})};var E=function(Q){return Q.aes.decryptText(d(Q.storage,"signed"),d(Q.storage,"uuid"),{nBits:256,salt:d(Q.storage,"iv")})};var p=function(R,Q){a("#"+R.form+" > textarea").val(E(R,Q))};var C=function(Q){(d(Q.storage,"uuid"))?j(Q.storage,"uuid"):false;(d(Q.storage,"pub"))?j(Q.storage,"pub"):false;(d(Q.storage,"certificate"))?j(Q.storage,"certificate"):false;(d(Q.storage,"iv"))?j(Q.storage,"iv"):false;(d(Q.storage,"signed"))?j(Q.storage,"signed"):false};var P=function(Q){var R={};a.each(a("#"+Q.form+" > :input"),function(T,S){if((m(S.value))&&(m(S.name))){R[S.name]=(parseInt(S.value.length)>80)?r(S.value):S.value}});return R};var A=function(Q){var R=0;a.each(Q,function(T,S){if(Q.hasOwnProperty(T)){R++}});return R};var r=function(U){var S=U.length/80;var V={};var Q=0;var T=80;for(var R=0;R<S;R++){if(R>0){Q=Q+80;T=T+80}if(U.slice(Q,T).length>0){V[R]=U.slice(Q,T)}}return V};var B=function(Q){if(Q.debug){a("#"+Q.form).append("<b>Processing form contents...</b><br/>");a("#"+Q.form).append("&nbsp;<i>UUID:</i> "+d(Q.storage,"uuid")+"<br/>");a("#"+Q.form).append("&nbsp;<i>IV:</i> "+d(Q.storage,"iv")+"<br/>");a("#"+Q.form).append("&nbsp;<i>KEY:</i> "+L(Q)+"<br/>")}return true};var z=function(Q,R){if(A(R)>0){a("#"+Q.form).append("<b>Encrypted data:</b><br/>");a.each(R,function(T,S){if(typeof S==="object"){a("#"+Q.form).append("&nbsp;<i>"+T+":</i><br/>");a.each(S,function(U,V){a("#"+Q.form).append("&nbsp;<i>"+U+"</i> = "+V+"<br/>")})}else{a("#"+Q.form).append("&nbsp;<i>"+T+"</i> = "+S+"<br/>")}})}};var e=function(T,S,R){var Q=false;T=(O(T))?T:"cookie";switch(T){case"localStorage":Q=v(S,R);break;case"sessionStorage":Q=u(S,R);break;case"cookie":Q=k(S,R);break;default:Q=v(S,R);break}return Q};var d=function(S,R){var Q=false;S=(O(S))?S:"cookie";switch(S){case"localStorage":Q=y(R);break;case"sessionStorage":Q=b(R);break;case"cookie":Q=f(R);break;default:Q=y(R);break}return Q};var j=function(S,R){var Q=false;S=(O(S))?S:"cookie";switch(S){case"localStorage":Q=o(R);break;case"sessionStorage":Q=G(R);break;case"cookie":Q=H(R);break;default:Q=o(R);break}return Q};var v=function(R,Q){return(localStorage.setItem(R,Q))?false:true};var u=function(R,Q){return(sessionStorage.setItem(R,Q))?false:true};var k=function(R,Q){if(typeof a.cookie==="function"){return(a.cookie(R,Q,{expires:7}))?true:false}else{return false}};var y=function(Q){return(localStorage.getItem(Q))?localStorage.getItem(Q):false};var b=function(Q){return(sessionStorage.getItem(Q))?sessionStorage.getItem(Q):false};var f=function(Q){if(typeof a.cookie==="function"){return(a.cookie(Q))?a.cookie(Q):false}else{return false}};var o=function(Q){return(localStorage.removeItem(Q))?localStorage.removeItem(Q):false};var G=function(Q){return(sessionStorage.removeItem(Q))?sessionStorage.removeItem(Q):false};var H=function(Q){if(typeof a.cookie==="function"){return(a.cookie(Q,"",{expires:-7}))?true:false}else{return false}};var m=function(Q){return((Q===false)||(Q.length===0)||(!Q)||(Q===null)||(Q==="")||(typeof Q==="undefined"))?false:true};var O=function(Q){try{return((Q in window)&&(window[Q]))?true:false}catch(R){return false}};var I=function(V){var aa=V.split("\n");var Q=false;var R=false;var S=false;var X="";var T={};T.info="";T.salt="";T.iv;T.b64="";T.aes=false;T.mode="";T.bits=0;for(var W=0;W<aa.length;W++){X=aa[W].substr(0,9);if(W==1&&X!="Proc-Type"&&X.indexOf("M")==0){R=true}switch(X){case"-----BEGI":Q=true;break;case"Proc-Type":if(Q){T.info=aa[W]}break;case"DEK-Info:":if(Q){var U=aa[W].split(",");var Z=U[0].split(": ");var Y=Z[1].split("-");T.aes=(Y[0]=="AES")?true:false;T.mode=Y[2];T.bits=parseInt(Y[1]);T.salt=U[1].substr(0,16);T.iv=U[1]}break;case"":if(Q){R=true}break;case"-----END ":if(Q){R=false;Q=false}break;default:if(Q&&R){T.b64+=pidCryptUtil.stripLineFeeds(aa[W])}}}return T};var n=function(R){var Q=true;if(!a.isFunction(pidCrypt.RSA.prototype.encrypt)){console.log("pidCrypt RSA libraries are missing.Please include the pidCrypt RSA libs...");console.log("Download them from https://www.pidder.com/pidcrypt/");console.log("See README document for necessary includes");Q=false}if(!a.isFunction(pidCrypt.AES.CBC)){console.log("pidCrypt AES-CBC libraries are missing.Please include the pidCrypt AES-CBC libs...");console.log("Download them from https://www.pidder.com/pidcrypt/");console.log("See README document for necessary includes");Q=false}if(R.storage==="cookie"){if(!a.isFunction(a.cookie)){console.log("Cookie use specified but required libraries not available.Please include the jQuery cookie plugin...");console.log("Download it from https://github.com/carhartl/jquery-cookie");Q=false}}return Q};var t=function(Q){a.each(Q,function(R,S){if(typeof S==="object"){t(S)}else{console.log(R+" => "+S)}})};if(x[N]){return x[N].apply(this,Array.prototype.slice.call(arguments,1))}else{if((typeof N==="object")||(!N)){return x.init.apply(this,arguments)}else{console.log("Method "+N+" does not exist")}}}})(jQuery);
